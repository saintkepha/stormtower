// Generated by CoffeeScript 1.7.1
(function() {
  var StormAgent, StormBolt, StormData, StormRegistry, StormTower, TowerAgent, TowerRegistry,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  StormAgent = require('stormagent');

  StormData = StormAgent.StormData;

  TowerAgent = (function(_super) {
    var async, crypto, http;

    __extends(TowerAgent, _super);

    async = require('async');

    http = require('http');

    crypto = require('crypto');

    function TowerAgent(id, bolt) {
      this.id = id;
      this.bolt = bolt;
      this.status = false;
      this.checksum = null;
      this.monitoring = false;
      TowerAgent.__super__.constructor.call(this, id);
    }

    TowerAgent.prototype.monitor = function(interval) {
      var extend;
      if (this.monitoring) {
        return;
      }
      extend = require('util')._extend;
      this.monitoring = true;
      return async.whilst((function(_this) {
        return function() {
          return _this.monitoring;
        };
      })(this), (function(_this) {
        return function(repeat) {
          var err, relay, req, streamBuffers;
          try {
            streamBuffers = require('stream-buffers');
            req = new streamBuffers.ReadableStreamBuffer;
            req.method = 'GET';
            req.url = '/';
            req.target = 5000;
            _this.log("monitor - checking " + _this.bolt.id + " for status");
            relay = _this.bolt.relay(req);
            return relay.on('reply', function(reply) {
              var checksum, copy, err, md5, status;
              try {
                status = JSON.parse(reply.body);
                copy = extend({}, status);
                delete copy.os;
                md5 = crypto.createHash("md5");
                md5.update(JSON.stringify(copy));
                checksum = md5.digest("hex");
                if (checksum !== _this.checksum) {
                  _this.checksum = checksum;
                  if (!_this.status) {
                    _this.emit('ready');
                  }
                  _this.status = status;
                  return _this.emit('changed');
                }
              } catch (_error) {
                err = _error;
                _this.log("unable to parse reply:", reply);
                _this.log("error:", err);
                return relay.end();
              }
            });
          } catch (_error) {
            err = _error;
            return _this.log("monitor - agent discovery request failed:", err);
          } finally {
            _this.log("monitor - scheduling repeat at " + interval);
            setTimeout(repeat, interval);
          }
        };
      })(this), (function(_this) {
        return function(err) {
          _this.log("monitor - agent discovery stopped for: " + _this.id);
          return _this.monitoring = false;
        };
      })(this));
    };

    TowerAgent.prototype.destroy = function() {
      return this.monitoring = false;
    };

    return TowerAgent;

  })(StormData);

  StormRegistry = StormAgent.StormRegistry;

  TowerRegistry = (function(_super) {
    __extends(TowerRegistry, _super);

    function TowerRegistry(filename) {
      this.on('removed', function(tagent) {
        if (tagent.destroy != null) {
          return tagent.destroy();
        }
      });
      TowerRegistry.__super__.constructor.call(this, filename);
    }

    TowerRegistry.prototype.get = function(key) {
      var entry, _base;
      entry = TowerRegistry.__super__.get.call(this, key);
      if (!((entry != null) && (entry.status != null))) {
        return;
      }
      if ((_base = entry.status).id == null) {
        _base.id = entry.id;
      }
      return entry.status;
    };

    return TowerRegistry;

  })(StormRegistry);

  StormBolt = require('stormbolt');

  StormTower = (function(_super) {
    __extends(StormTower, _super);

    function StormTower(config) {
      StormTower.__super__.constructor.call(this, config);
      this["import"](module);
      this.agents = new TowerRegistry;
      this.clients.on('added', (function(_this) {
        return function(bolt) {
          var tagent;
          tagent = new TowerAgent(bolt.id, bolt);
          tagent.monitor(_this.config.monitorInterval);
          return tagent.once('ready', function() {
            _this.agents.add(bolt.id, tagent);
            return tagent.on('changed', function() {
              return _this.agents.emit('changed');
            });
          });
        };
      })(this));
      this.clients.on('removed', (function(_this) {
        return function(bolt) {
          _this.log("boltstream " + bolt.id + " is removed");
          return _this.agents.remove(bolt.id);
        };
      })(this));
    }

    StormTower.prototype.status = function() {
      var state;
      state = StormTower.__super__.status.apply(this, arguments);
      state.agents = this.agents.list();
      return state;
    };

    return StormTower;

  })(StormBolt);

  module.exports = StormTower;

}).call(this);
